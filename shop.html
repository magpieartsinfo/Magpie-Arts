<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>shop | Magpie Arts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Roboto+Serif:opsz,wght@8..144,700&display=swap" rel="stylesheet" />
  <style>
    /* [All existing CSS as you provided, omitted here for brevity] */
    /* ... your previous CSS ... */

    /* Responsive tweaks */
    @media (max-width: 850px) {
      .side-logo { display: none; }
      .header-bar { margin: 0; border-radius: 0; padding: 10px 20px; }
      nav { margin: 0; flex-wrap: wrap; gap: 16px; justify-content: center; }
      .shop-container { margin: 0; padding: 10px; }
      .pie-logo-center { width: 210px; }
      .footer-contact-shop { margin: 0 2vw; }
    }
    @media (max-width: 600px) {
      .shop-container { padding: 0 8px 50px; }
      .product-card { width: 95vw; }
      #wishlistModal { width: 90vw; max-height: 320px; right: 5vw; top: 70px; }
      .pie-logo-center { width: 130px; }
      .footer-contact-shop { border-radius: 18px; padding: 15px 4vw; }
      .footer-contact-shop p { font-size: 0.94rem; }
    }
  </style>
</head>
<body>
  <!-- Your HTML (unchanged) -->
  <div id="sideMenu" style="..."> <!-- as before --> </div>
  <div id="menuOverlay" style="..."></div>
  <a href="index.html" class="side-logo" aria-label="Home"><img src="..." alt="Logo" /></a>
  <div class="header-bar">
    <!-- header content as before -->
  </div>
  <nav>
    <a href="#" onclick="filterCategory('All', this)">Paint By Number Kit</a>
    <a href="#" onclick="filterCategory('Custom', this)">Custom Kit</a>
    <a href="#" onclick="filterCategory('Devotion/Spiritual', this)">Devotion/Spiritual</a>
    <a href="#" onclick="filterCategory('Scenery/Wonders', this)">Scenery/Wonders</a>
    <a id="wishlist-link" onclick="toggleWishlistModal()">❤ Wishlist</a>
  </nav>
  <main class="shop-container">
    <div class="products-grid" id="productsGrid"></div>
  </main>
  <div id="wishlistModal" role="dialog" aria-modal="true" aria-labelledby="wishlistTitle">
    <h2 id="wishlistTitle">Your Wishlist</h2>
    <div id="wishlistItems"></div>
  </div>
  <footer class="footer-contact-shop" aria-label="Footer">
    <!-- footer unchanged -->
  </footer>
  <script>
    const productsGrid = document.getElementById('productsGrid');
    const wishlistModal = document.getElementById('wishlistModal');
    const wishlistItems = document.getElementById('wishlistItems');
    const wishlistLink = document.getElementById('wishlist-link');
    let products = [];
    let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
    let currentCategory = 'All';

    async function fetchProducts() {
      try {
        const response = await fetch('https://raw.githubusercontent.com/magpieartsinfo/magpie-arts-site/main/products.json');
        if (!response.ok) throw new Error('Failed to load products');
        return await response.json();
      } catch (error) {
        console.error(error);
        return [];
      }
    }

    function getLowestPrice(prod) {
      const prices = [prod.priceS1C16, prod.priceS1C20, prod.priceS2C20, prod.priceS2C24].filter(p => typeof p === 'number' && p > 0);
      return prices.length ? Math.min(...prices) : 'N/A';
    }

    function renderProducts() {
      productsGrid.innerHTML = '';
      let filtered;
      if(currentCategory === 'All'){
        const customKit = products.find(p => p.isCustomKit);
        const others = products.filter(p => !p.isCustomKit);
        filtered = customKit ? [customKit, ...others] : others;
      } else {
        filtered = products.filter(p => p.category === currentCategory);
      }

      if(filtered.length === 0){
        productsGrid.innerHTML = `<p style="text-align:center; font-size:1.3rem; width:100%;">No products found.</p>`;
        return;
      }

      filtered.forEach((prod, idx) => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.onclick = () => openProductPage(products.indexOf(prod));
        card.innerHTML = `
          <div class="product-img-window">
            <img src="${prod.image}" alt="${prod.title}" class="product-img" loading="lazy" />
          </div>
          <div class="product-title">${prod.title}</div>
          <div class="product-price">Starting at Rs. ${getLowestPrice(prod).toLocaleString()}</div>
          <span class="wishlist-heart ${wishlist.includes(products.indexOf(prod)) ? 'wishlisted' : ''}" 
                onclick="toggleWishlist(event, ${products.indexOf(prod)})">❤</span>
        `;
        productsGrid.appendChild(card);
      });
    }

    function openProductPage(idx) {
      window.location.href = `product.html?index=${idx}`;
    }

    function filterCategory(category, element) {
      currentCategory = category;
      document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
      if (element) element.classList.add('active');
      renderProducts();
      closeWishlistModal();
    }

    function toggleWishlist(event, idx) {
      event.stopPropagation();
      if (wishlist.includes(idx)) {
        wishlist = wishlist.filter(i => i !== idx);
      } else {
        wishlist.push(idx);
      }
      localStorage.setItem('wishlist', JSON.stringify(wishlist));
      renderProducts();
      renderWishlist();
    }

    function renderWishlist() {
      if (!wishlist.length) {
        wishlistItems.innerHTML = '<p style="text-align:center; font-size:1.3rem;">Your Wishlist is empty.</p>';
        return;
      }
      wishlistItems.innerHTML = '';
      wishlist.forEach(idx => {
        const prod = products[idx];
        if(!prod) return;
        const div = document.createElement('div');
        div.className = 'wishlist-item';
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.alignItems = 'center';
        div.style.marginBottom = '1rem';
        div.style.cursor = 'pointer';
        div.onclick = () => openProductPage(idx);
        div.innerHTML = `
          <img src="${prod.image}" alt="${prod.title}" style="width:56px; height:76px; border-radius:12px; object-fit:cover; margin-right:10px;" />
          <div class="title" style="flex-grow:1; font-weight:700; font-size:1rem; color:#1b398d; text-align:left;">${prod.title}</div>
          <div class="remove-wish" title="Remove from WishList" 
               style="cursor:pointer; color:#e84265; font-weight:900; font-size:1.3rem; padding-left:10px;"
               onclick="event.stopPropagation(); removeWishlist(${idx});">&times;</div>
        `;
        wishlistItems.appendChild(div);
      });
    }

    function removeWishlist(idx) {
      wishlist = wishlist.filter(i => i !== idx);
      localStorage.setItem('wishlist', JSON.stringify(wishlist));
      renderProducts();
      renderWishlist();
    }

    function toggleWishlistModal() {
      if (wishlistModal.style.display === 'block') {
        wishlistModal.style.display = 'none';
      } else {
        renderWishlist();
        wishlistModal.style.display = 'block';
      }
    }

    function closeWishlistModal() {
      wishlistModal.style.display = 'none';
    }

    // Menu open/close control
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const menuBtn = document.querySelector('.menu-icon');

    menuBtn.addEventListener('click', () => {
      if (sideMenu.style.right === '0px') {
        closeMenu();
      } else {
        openMenu();
      }
    });

    menuOverlay.addEventListener('click', closeMenu);

    function openMenu() {
      sideMenu.style.right = '0px';
      menuOverlay.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      sideMenu.style.right = '-260px';
      menuOverlay.style.display = 'none';
      document.body.style.overflow = '';
    }

    window.addEventListener('DOMContentLoaded', async () => {
      // Fetch products from online JSON file
      try {
        const res = await fetch('https://raw.githubusercontent.com/magpieartsinfo/magpie-arts-site/main/products.json');
        if (!res.ok) throw new Error('Failed to fetch products');
        products = await res.json();
      } catch (e) {
        console.error(e);
        products = [];
      }
      // Initialize page with default or hash category
      const hash = window.location.hash.substring(1).toLowerCase();
      const categoryMap = {
        paint: 'All',
        custom: 'Custom',
        devotion: 'Devotion/Spiritual',
        scenery: 'Scenery/Wonders'
      };
      const initialCategory = categoryMap[hash] || 'All';
      const navLinks = document.querySelectorAll('nav a');
      navLinks.forEach(a => a.classList.remove('active'));
      const defaultLink = Array.from(navLinks).find(a => a.textContent.toLowerCase() === (hash || 'paint'));
      if (defaultLink) defaultLink.classList.add('active');
      filterCategory(initialCategory, document.querySelector(`nav a.active`));
    });
  </script>
</body>
</html>
