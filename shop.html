import { useState, useEffect } from "react";

interface Product {
  title: string;
  category: string;
  image: string;
  priceS1C16: number;
  priceS1C20?: number;
  priceS2C20?: number;
  priceS2C24?: number;
  isCustomKit?: boolean;
  description?: string;
}

const Index = () => {
  const [products, setProducts] = useState<Product[]>([]);
  const [currentCategory, setCurrentCategory] = useState("All");
  const [wishlist, setWishlist] = useState<number[]>([]);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [isWishlistOpen, setIsWishlistOpen] = useState(false);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadProductsFromJson();
    loadWishlist();
  }, []);

  const loadProductsFromJson = async () => {
    try {
      setLoading(true);
      const response = await fetch('https://raw.githubusercontent.com/magpieartsinfo/magpie-arts-site/main/products.json');
      
      if (response.ok) {
        const data = await response.json();
        setProducts(data);
      } else {
        console.error('Failed to fetch products from GitHub');
        setProducts([]);
      }
    } catch (err) {
      console.error('Product fetch failed:', err);
      setProducts([]);
    } finally {
      setLoading(false);
    }
  };

  const loadWishlist = () => {
    try {
      const saved = localStorage.getItem('wishlist');
      if (saved) {
        setWishlist(JSON.parse(saved));
      }
    } catch (err) {
      console.error('Failed to load wishlist:', err);
    }
  };

  const saveWishlist = () => {
    localStorage.setItem('wishlist', JSON.stringify(wishlist));
  };

  const toggleWishlist = (e: React.MouseEvent, index: number) => {
    e.stopPropagation();
    const newWishlist = wishlist.includes(index)
      ? wishlist.filter(i => i !== index)
      : [...wishlist, index];
    setWishlist(newWishlist);
    localStorage.setItem('wishlist', JSON.stringify(newWishlist));
  };

  const removeFromWishlist = (index: number) => {
    const newWishlist = wishlist.filter(i => i !== index);
    setWishlist(newWishlist);
    localStorage.setItem('wishlist', JSON.stringify(newWishlist));
  };

  const getStartingPrice = (prod: Product) => {
    const prices = [prod.priceS1C16, prod.priceS1C20, prod.priceS2C20, prod.priceS2C24].filter(p => typeof p === 'number' && p > 0);
    if (prices.length === 0) return prod.priceS1C16;
    return Math.min(...prices);
  };

  const openProductPage = (index: number) => {
    window.location.href = `https://magpieartsinfo.github.io/magpie-arts-site/product.html?index=${index}`;
  };

  const filterCategory = (cat: string, el?: HTMLElement) => {
    setCurrentCategory(cat);
    document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
    if (el) el.classList.add('active');
    renderProducts();
    setIsWishlistOpen(false);
  };

  const openMenu = () => {
    setIsMenuOpen(true);
    document.body.style.overflow = 'hidden';
  };

  const closeMenu = () => {
    setIsMenuOpen(false);
    document.body.style.overflow = '';
  };

  const menuFilter = (cat: string) => {
    closeMenu();
    const navs = document.querySelectorAll('nav a');
    navs.forEach(a => {
      if (a.textContent?.trim().toLowerCase().includes(cat.toLowerCase())) {
        (a as HTMLElement).click();
      }
    });
  };

  const getFilteredProducts = () => {
    if (currentCategory === "All") {
      const customKitProduct = products.find(p => p.isCustomKit);
      const notCustomKit = products.filter(p => !p.isCustomKit);
      const filtered = [];
      if (customKitProduct) filtered.push(customKitProduct);
      return filtered.concat(notCustomKit);
    } else {
      return products.filter(p => p.category === currentCategory);
    }
  };

  const renderProducts = () => {
    // This will trigger re-render
  };

  const filteredProducts = getFilteredProducts();

  return (
    <>
      <style>{`
        body {
          font-family: 'Candara', Arial, sans-serif;
          background: #f8fbff;
          margin: 0; 
          padding: 0 20px 50px;
          color: #222;
        }
        .side-logo {
          position: fixed;
          top: 24px;
          left: 28px;
          width: 110px;
          height: auto;
          background: #fff;
          border-radius: 16px;
          padding: 7px 12px;
          border: 3px solid #d9eefb;
          box-shadow: 0 6px 40px 0 rgba(60,90,170,0.09);
          cursor: pointer;
          z-index: 1000;
          text-decoration: none;
        }
        .side-logo:hover {
          box-shadow: 0 8px 50px rgba(60,90,170,0.3);
        }
        .header-bar {
          background: linear-gradient(90deg, #b4d9f6 0%, #eaeefe 50%, #97d2f7 100%);
          min-height: 160px;
          margin-left: 160px;
          border-radius: 32px 0 32px 0;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          box-shadow: 0 8px 26px #6599f3b2;
          padding: 0 80px;
        }
        .menu-icon {
          position: absolute;
          right: 24px;
          left: auto;
          top: 50%;
          transform: translateY(-50%);
          width: 52px;
          height: 52px;
          background: #e6f0ff;
          border-radius: 50%;
          box-shadow: 0 4px 15px rgba(18, 68, 170, 0.14);
          cursor: pointer;
          z-index: 12;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: background 0.3s;
          padding: 7px;
        }
        .menu-icon:hover {
          background: #c6ddff;
        }
        .menu-icon svg {
          width: 36px;
          height: 36px;
          display: block;
        }
        .pie-logo-center {
          margin: 0 auto;
          max-width: 330px;
          width: 330px;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 7px 8px 3px 8px;
          background: none;
          z-index: 5;
          user-select: none;
        }
        .pie-logo-center img {
          width: 100%;
          height: auto;
          display: block;
          margin: 0 auto;
          user-select: none;
          pointer-events: none;
        }
        .home-icon-link {
          position: absolute;
          left: 24px;
          right: auto;
          top: 50%;
          transform: translateY(-50%);
          width: 52px;
          height: 52px;
          cursor: pointer;
          fill: #1b3a8d;
          transition: fill 0.3s;
          user-select: none;
          border-radius: 50%;
          background: #e6f0ff;
          box-shadow: 0 4px 14px rgba(30, 78, 170, 0.22);
          padding: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .home-icon-link:hover {
          fill: #2979ff;
          background: #c4ddff;
        }
        nav {
          margin-top: 18px;
          margin-left: 160px;
          display: flex;
          justify-content: center;
          gap: 26px;
          font-family: Arial, sans-serif;
          flex-wrap: wrap;
        }
        nav a {
          font-weight: 700;
          font-size: 1.2rem;
          color: #154ea4;
          text-decoration: none;
          padding: 8px 20px;
          border-radius: 14px;
          cursor: pointer;
          user-select: none;
          transition: background-color 0.3s ease;
          white-space: nowrap;
        }
        nav a.active, nav a:hover {
          background-color: #e4f3ff;
          color: #2a72ea;
        }
        nav #wishlist-link {
          color: #e84265 !important;
          font-size: 1.4rem;
          margin-left: 50px;
        }
        .shop-container {
          max-width: 1320px;
          margin: 32px auto 0 auto;
          margin-left: 160px;
          padding-right: 8px;
        }
        .products-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill,minmax(280px,1fr));
          gap: 25px 28px;
          justify-items: center;
        }
        .product-card {
          background: white;
          border-radius: 24px;
          box-shadow: 0 6px 35px #d7e0f7cc;
          width: 280px;
          cursor: pointer;
          display: flex;
          flex-direction: column;
          align-items: center;
          position: relative;
          padding: 20px 28px 18px 28px;
          transition: box-shadow 0.25s ease, transform 0.25s ease;
          user-select: none;
        }
        .product-card:hover {
          box-shadow: 0 11px 50px #6ea3fc7f;
          transform: translateY(-4px);
        }
        .product-img-window {
          width: 207px;
          height: 276px;
          background: #e7f3fa;
          border-radius: 18px;
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
          box-shadow: 0 4px 18px #bdd9fc77;
          margin-bottom: 1.1rem;
          position: relative;
        }
        .product-img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          border-radius: 18px;
          transition: transform 0.4s ease;
        }
        .product-card:hover .product-img {
          transform: scale(1.08);
        }
        .product-title {
          font-family: 'Candara', Arial, sans-serif;
          font-size: 1.3rem;
          font-weight: 700;
          color: #264a8b;
          text-align: center;
          margin-bottom: 0.3rem;
          min-height: 44px;
        }
        .product-price {
          font-family: Arial, sans-serif;
          font-size: 1.1rem;
          font-weight: 700;
          color: #1c3a92;
          margin-bottom: 1rem;
          text-align: center;
        }
        .wishlist-heart {
          position: absolute;
          top: 22px;
          right: 22px;
          font-size: 1.9rem;
          color: #bbb;
          cursor: pointer;
          transition: color 0.25s;
          user-select: none;
          z-index: 22;
        }
        .wishlist-heart.wishlisted {
          color: #e84265;
          text-shadow: 0 3px 12px #fda3bb;
        }
        .wishlist-heart:hover {
          color: #e84265;
        }
        .loading-indicator {
          text-align: center;
          padding: 40px;
          font-size: 1.2rem;
          color: #3c59ff;
        }
        .error-message {
          text-align: center;
          padding: 40px;
          font-size: 1.2rem;
          color: #e84265;
        }
        .footer-contact-shop {
          background: #172a59;
          color: #fff;
          padding: 30px 16px 20px 16px;
          border-radius: 38px;
          text-align: center;
          margin: 38px 12px 16px 12px;
          font-family: Arial, sans-serif;
          max-width: 100%;
        }
        .footer-contact-shop .contact-info p {
          margin: 5px 0;
          font-size: 1.1rem;
          color: #fff;
          line-height: 1.5;
        }
        .footer-contact-shop .contact-info p strong {
          font-size: 1.18rem;
          color: #fff;
        }
        #wishlistModal {
          position: fixed;
          top: 90px;
          right: 20px;
          width: 340px;
          max-height: 500px;
          background: white;
          box-shadow: 0 0 40px rgba(30,78,170,0.25);
          border-radius: 20px;
          overflow-y: auto;
          padding: 21px 25px 25px 25px;
          z-index: 1999;
          display: ${isWishlistOpen ? 'block' : 'none'};
        }
        #wishlistModal h2 {
          font-weight: 800;
          text-align: center;
          margin: 0 0 15px 0;
          color: #1f3e83;
          font-size: 1.4rem;
        }
        #wishlistModal .wishlist-item {
          display: flex;
          align-items: center;
          margin-bottom: 1rem;
          justify-content: space-between;
        }
        #wishlistModal img {
          width: 56px;
          height: 76px;
          object-fit: cover;
          border-radius: 14px;
          margin-right: 14px;
        }
        #wishlistModal .wish-title {
          flex-grow: 1;
          font-weight: 700;
          font-size: 1rem;
          color: #1b3a8d;
          text-align: left;
        }
        #wishlistModal .remove-wish {
          font-size: 1.4rem;
          color: #e84265;
          cursor: pointer;
          font-weight: 900;
          padding-left: 15px;
          user-select: none;
        }
        @media (max-width: 850px) {
          .side-logo { display: none; }
          .header-bar { margin-left: 0; border-radius: 0;}
          nav { margin-left: 0; flex-wrap: wrap; gap: 18px;}
          .shop-container { margin-left: 0; padding: 0 10px;}
          .pie-logo-center { width: 210px; }
          .footer-contact-shop { margin-left: 2vw; margin-right: 2vw; }
        }
        @media (max-width: 600px) {
          .shop-container {padding: 0 6px;}
          .product-card {width: 95vw;}
          #wishlistModal { width: 90vw; max-height: 320px; right: 5vw; top: 70px;}
          .pie-logo-center { width: 130px; }
          .footer-contact-shop { border-radius: 18px; padding: 15px 4vw; }
          .footer-contact-shop .contact-info p { font-size: 0.94rem; }
        }
      `}</style>

      {/* Side Menu */}
      <div style={{
        position: 'fixed',
        top: 0,
        right: isMenuOpen ? '0px' : '-260px',
        left: 'auto',
        width: '240px',
        height: '100vh',
        background: '#e6f0ff',
        boxShadow: '2px 0 20px rgba(43,58,128,0.12)',
        padding: '48px 0 24px 0',
        zIndex: 2000,
        transition: 'right 0.3s cubic-bezier(.77,0,.175,1)',
        display: 'flex',
        flexDirection: 'column'
      }}>
        <ul style={{
          padding: '0 0 0 26px',
          margin: 0,
          listStyle: 'none',
          fontSize: '1.17rem',
          fontWeight: 700,
          color: '#1747a0',
          userSelect: 'none'
        }}>
          <li style={{ marginBottom: '28px' }}>
            <a href="#" onClick={(e) => { e.preventDefault(); menuFilter('All'); }}>Paint By Number</a>
          </li>
          <li style={{ marginBottom: '28px' }}>
            <a href="#" onClick={(e) => { e.preventDefault(); menuFilter('Custom'); }}>Custom Kit</a>
          </li>
          <li style={{ marginBottom: '28px' }}>
            <a href="#" onClick={(e) => { e.preventDefault(); menuFilter('Devotion/Spiritual'); }}>Devotion/Spiritual</a>
          </li>
          <li style={{ marginBottom: '28px' }}>
            <a href="#" onClick={(e) => { e.preventDefault(); menuFilter('Scenery/Wonders'); }}>Scenery/Wonders</a>
          </li>
          <li style={{ marginBottom: '28px' }}>
            <a href="#" onClick={closeMenu}>Cart</a>
          </li>
          <li style={{ color: '#7080a3', fontWeight: 400, fontSize: '.95rem', marginTop: '30px' }}>
            © 2025 Magpie Arts
          </li>
        </ul>
      </div>

      {isMenuOpen && (
        <div
          style={{
            position: 'fixed',
            top: 0,
            right: 0,
            left: 'auto',
            width: '100vw',
            height: '100vh',
            background: 'rgba(14,42,139,0.15)',
            zIndex: 1999
          }}
          onClick={closeMenu}
        />
      )}

      <a href="https://magpieartsinfo.github.io/magpie-arts-site/index.html" title="Home">
        <img 
          className="side-logo" 
          src="https://raw.githubusercontent.com/magpieartsinfo/magpiearts-assets/main/magpie-arts-site/images/logo.png" 
          alt="Magpie Arts Logo" 
        />
      </a>

      <div className="header-bar">
        <span 
          className="menu-icon" 
          role="button" 
          aria-label="Menu" 
          tabIndex={0} 
          title="Menu"
          onClick={openMenu}
        >
          <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
            <rect x="2" y="2" width="15" height="15" rx="6" fill="#285be8"/>
            <rect x="19" y="2" width="15" height="15" rx="6" fill="#9ac1fc"/>
            <rect x="2" y="19" width="15" height="15" rx="6" fill="#285be8"/>
            <rect x="19" y="19" width="15" height="15" rx="6" fill="#285be8"/>
          </svg>
        </span>
        
        <div className="pie-logo-center">
          <img 
            src="https://raw.githubusercontent.com/magpieartsinfo/magpiearts-assets/main/magpie-arts-site/images/PIE-kits.png" 
            alt="PIE Kits - Paint It Easily Logo" 
            draggable="false" 
            loading="lazy" 
          />
        </div>
        
        <a 
          href="https://magpieartsinfo.github.io/magpie-arts-site/index.html" 
          className="home-icon-link" 
          title="Home" 
          aria-label="Home"
        >
          <svg viewBox="0 0 24 24" fill="currentColor" role="img">
            <path d="M12 3l10 9h-3v9h-6v-6h-2v6H5v-9H2z"/>
          </svg>
        </a>
      </div>

      <nav>
        <a href="#" onClick={(e) => { e.preventDefault(); filterCategory('All', e.target as HTMLElement); }}>
          Paint By Number Kit
        </a>
        <a href="#" onClick={(e) => { e.preventDefault(); filterCategory('Custom', e.target as HTMLElement); }}>
          Custom Kit
        </a>
        <a href="#" onClick={(e) => { e.preventDefault(); filterCategory('Devotion/Spiritual', e.target as HTMLElement); }}>
          Devotion/Spiritual
        </a>
        <a href="#" onClick={(e) => { e.preventDefault(); filterCategory('Scenery/Wonders', e.target as HTMLElement); }}>
          Scenery/Wonders
        </a>
        <a 
          id="wishlist-link" 
          title="Wishlist" 
          onClick={() => setIsWishlistOpen(!isWishlistOpen)}
        >
          ❤ Wishlist
        </a>
      </nav>

      <main className="shop-container">
        <div className="products-grid">
          {loading ? (
            <div className="loading-indicator">Loading products...</div>
          ) : filteredProducts.length === 0 ? (
            <p style={{ textAlign: 'center', fontSize: '1.3rem', width: '100%' }}>
              No products found in this category.
            </p>
          ) : (
            filteredProducts.map((prod, idx) => {
              const originalIndex = products.findIndex(p => p === prod);
              return (
                <div 
                  key={`${prod.title}-${originalIndex}`}
                  className="product-card"
                  onClick={() => openProductPage(originalIndex)}
                >
                  <div className="product-img-window">
                    <img 
                      src={prod.image} 
                      alt={prod.title} 
                      className="product-img" 
                      loading="lazy"
                    />
                  </div>
                  <div className="product-title">{prod.title}</div>
                  <div className="product-price">
                    Starting at Rs. {getStartingPrice(prod).toLocaleString()}
                  </div>
                  <span 
                    title="Add to Wishlist" 
                    className={`wishlist-heart ${wishlist.includes(originalIndex) ? 'wishlisted' : ''}`}
                    onClick={(e) => toggleWishlist(e, originalIndex)}
                  >
                    ❤
                  </span>
                </div>
              );
            })
          )}
        </div>
      </main>

      <div id="wishlistModal">
        <h2>Your Wishlist</h2>
        <div>
          {wishlist.length === 0 ? (
            <p style={{ textAlign: 'center', fontSize: '1.1rem', marginTop: '1.2rem' }}>
              Your wishlist is empty.
            </p>
          ) : (
            wishlist.map(index => {
              const prod = products[index];
              if (!prod) return null;
              return (
                <div key={index} className="wishlist-item">
                  <div 
                    style={{ 
                      display: 'flex', 
                      alignItems: 'center', 
                      flexGrow: 1, 
                      cursor: 'pointer' 
                    }}
                    onClick={() => openProductPage(index)}
                  >
                    <img 
                      src={prod.image} 
                      alt={prod.title}
                      style={{
                        width: '60px',
                        height: '80px',
                        objectFit: 'cover',
                        borderRadius: '12px',
                        marginRight: '12px'
                      }}
                    />
                    <div className="wish-title">{prod.title}</div>
                  </div>
                  <div 
                    className="remove-wish"
                    title="Remove from wishlist"
                    onClick={(e) => {
                      e.stopPropagation();
                      removeFromWishlist(index);
                    }}
                  >
                    ×
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>

      {/* Close wishlist when clicking outside */}
      {isWishlistOpen && (
        <div
          style={{
            position: 'fixed',
            inset: 0,
            zIndex: 1998
          }}
          onClick={() => setIsWishlistOpen(false)}
        />
      )}

      <footer className="footer-contact-shop">
        <div className="contact-info">
          <p><strong>Contact Us</strong></p>
          <p>
            Phone: +91-8128136985 &nbsp;|&nbsp;
            Email: <a href="mailto:magpieartsinfo@gmail.com" style={{ color: '#fff', textDecoration: 'underline' }}>
              magpieartsinfo@gmail.com
            </a>
          </p>
          <p>Address: 285, Manmandir Residency, Ankleshwar, Gujarat-393001</p>
        </div>
        <nav 
          className="social-icons" 
          style={{ 
            marginTop: '20px', 
            display: 'flex', 
            justifyContent: 'center', 
            gap: '28px' 
          }} 
          aria-label="Social media links"
        >
          <a href="https://api.whatsapp.com/send?phone=9181283685" target="_blank" aria-label="WhatsApp">
            <img 
              src="https://raw.githubusercontent.com/magpieartsinfo/magpiearts-assets/refs/heads/main/magpie-arts-site/images/whatsapp-icon.svg" 
              alt="WhatsApp" 
              width="38" 
              height="38" 
            />
          </a>
          <a href="https://www.linkedin.com/company/magpie-arts/?viewAsMember=true" target="_blank" aria-label="LinkedIn">
            <img 
              src="https://raw.githubusercontent.com/magpieartsinfo/magpiearts-assets/refs/heads/main/magpie-arts-site/images/linkedin-icon.svg" 
              alt="LinkedIn" 
              width="38" 
              height="38" 
            />
          </a>
          <a href="https://www.instagram.com/magpiearts27?igsh=cWMxZ2UydWV3ZHdy" target="_blank" aria-label="Instagram">
            <img 
              src="https://raw.githubusercontent.com/magpieartsinfo/magpiearts-assets/refs/heads/main/magpie-arts-site/images/instagram-icon.svg" 
              alt="Instagram" 
              width="38" 
              height="38" 
            />
          </a>
          <a href="https://www.facebook.com/share/1QVHnxCqRB/" target="_blank" aria-label="Facebook">
            <img 
              src="https://raw.githubusercontent.com/magpieartsinfo/magpiearts-assets/refs/heads/main/magpie-arts-site/images/facebook-icon.svg" 
              alt="Facebook" 
              width="38" 
              height="38" 
            />
          </a>
        </nav>
      </footer>
    </>
  );
};

export default Index;