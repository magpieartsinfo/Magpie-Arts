<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Checkout | Magpie Arts</title>
<style>
.back-arrow-btn {
  background: none;
  border: none;
  padding: 0;
  margin-bottom: 14px;
  margin-left: 8px;
  cursor: pointer;
  border-radius: 50%;
  box-shadow: 0 1.5px 7px #d7d7d7;
  width: 38px;
  height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.back-arrow-btn:hover {
  background: #e0eaff;
}
body {
  font-family: Arial, sans-serif;
  max-width: 500px;
  margin: 25px auto;
  background: #f8faff;
  padding: 20px;
}
.logo-container {
  text-align: center;
  margin-bottom: 20px;
}
.logo-container img {
  width: 150px;
  border-radius: 12px;
  box-shadow: 0 0 10px #abc;
}
h1 {
  text-align: center;
  margin-bottom: 20px;
}
#cartDescription {
  background: #eef5ff;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 20px;
  color: #1e3a8a;
}
#cartDescription ul {
  margin-left: 20px;
  padding: 0;
  list-style-type: none;
}
.cart-item {
  margin-bottom: 12px;
  padding: 10px;
  border-bottom: 1px solid #cfd8ff;
}
.cart-item strong {
  color: #1e3a8a;
}
form {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 12px #ccc;
}
.form-group {
  margin-bottom: 15px;
}
label {
  font-weight: bold;
}
input, select, textarea {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #a9c4ff;
  font-size: 1rem;
}
input:invalid,select:invalid {
  border-color: red;
}
button[type="submit"] {
  background: #3c59ff;
  color: #fff;
  border: none;
  padding: 12px;
  border-radius: 10px;
  font-size: 1.2rem;
  font-weight: bold;
  cursor: pointer;
  width: 100%;
}
button[type="submit"]:hover {
  background: #2a43c6;
}
textarea {
  resize: vertical;
  height: 80px;
}
#photoUploadContainer {
  display: none;
  margin-bottom: 15px;
}
.loading {
  opacity: 0.7;
  pointer-events: none;
}
.success-message {
  background-color: #d4edda;
  color: #155724;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 20px;
  text-align: center;
  display: none;
}
.error-message {
  background-color: #f8d7da;
  color: #721c24;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 20px;
  text-align: center;
  display: none;
}
</style>
</head>
<body>
  <div class="logo-container">
    <img src="https://raw.githubusercontent.com/magpieartsinfo/magpiearts-assets/main/magpie-arts-site/images/logo.png" alt="Magpie Arts Logo" />
  </div>
  <button class="back-arrow-btn" onclick="history.back()" aria-label="Go Back">
    <svg width="24" height="24" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6" stroke="#3c59ff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>
  <h1>Checkout</h1>
  <div id="successMessage" class="success-message">
    Order placed successfully! Thank you for your purchase.
  </div>
  <div id="errorMessage" class="error-message">
    There was an error processing your order. Please try again.
  </div>
  <div id="cartDescription" aria-label="Order Summary">
    <p><strong>Products in your order:</strong></p>
    <ul id="cartList"></ul>
    <p id="cartTotal" style="margin-top:10px; font-weight:bold;"></p>
  </div>
  <form id="checkoutForm" novalidate autocomplete="off">
    <div class="form-group">
      <label for="email">Email <span style="color:red">*</span></label>
      <input type="email" id="email" required />
    </div>
    <div class="form-group">
      <label for="firstName">First Name <span style="color:red">*</span></label>
      <input type="text" id="firstName" required />
    </div>
    <div class="form-group">
      <label for="lastName">Last Name <span style="color:red">*</span></label>
      <input type="text" id="lastName" required />
    </div>
    <div class="form-group">
      <label for="address">Address <span style="color:red">*</span></label>
      <input type="text" id="address" required />
    </div>
    <div class="form-group">
      <label for="apartment">Apartment, suite, etc. (optional)</label>
      <input type="text" id="apartment" />
    </div>
    <div class="form-group">
      <label for="city">City <span style="color:red">*</span></label>
      <input type="text" id="city" required />
    </div>
    <div class="form-group">
      <label for="state">State <span style="color:red">*</span></label>
      <select id="state" required>
        <option value="">Select State</option>
        <option>Gujarat</option>
        <option>Maharashtra</option>
        <option>Delhi</option>
        <option>Rajasthan</option>
        <option>Other</option>
      </select>
    </div>
    <div class="form-group">
      <label for="pincode">Pin Code <span style="color:red">*</span></label>
      <input type="text" id="pincode" required pattern="[0-9]{6}" />
    </div>
    <div class="form-group">
      <label for="phone">Phone <span style="color:red">*</span></label>
      <input type="tel" id="phone" required pattern="[0-9]{10}" />
    </div>
    <div class="form-group" id="photoUploadContainer">
      <label for="photoUpload">Upload Photo <span style="color:red">*</span></label>
      <input type="file" id="photoUpload" accept="image/*" />
    </div>
    <div class="form-group">
      <label for="comments">Comments / Notes (optional)</label>
      <textarea id="comments" placeholder="Any special instructions or messages"></textarea>
    </div>
    <button type="submit" id="submitButton">Place Order</button>
  </form>
  <!-- Include Supabase client library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase client
    const supabaseUrl = "https://rxtukfjjeruospodnkdz.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4dHVrZmpqZXJ1b3Nwb2Rua2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0ODc0NTQsImV4cCI6MjA3MzA2MzQ1NH0.-sgX4XjHiamnzyqDdlmBlrPgaPMgX8GbzdB1c2rnSc0";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    function getCartItems() {
      let cartItems = [];
      try {
        const directOrder = JSON.parse(sessionStorage.getItem("directOrder"));
        if (directOrder && Object.keys(directOrder).length) {
          cartItems = [directOrder];
          sessionStorage.removeItem("directOrder");
          return cartItems;
        }
      } catch (e) {}
      try {
        const storedCart = JSON.parse(localStorage.getItem("magpieCart"));
        if (Array.isArray(storedCart) && storedCart.length) {
          cartItems = storedCart;
        }
      } catch (e) {}
      return cartItems;
    }

    function shouldShowPhotoUpload(cartItems) {
      if (!cartItems.length) return false;
      return cartItems.some(item => /custom PIE kit/i.test(item.title));
    }

    const cartItems = getCartItems();
    const cartList = document.getElementById("cartList");
    const cartTotal = document.getElementById("cartTotal");
    const photoUploadContainer = document.getElementById("photoUploadContainer");
    const photoUploadInput = document.getElementById("photoUpload");

    function renderCart() {
      if (!cartItems.length) {
        cartList.innerHTML = "<li>No products in your order.</li>";
        cartTotal.textContent = "";
        photoUploadContainer.style.display = "none";
        return;
      }
      cartList.innerHTML = "";
      cartItems.forEach(item => {
        const li = document.createElement("li");
        li.className = "cart-item";
        li.innerHTML = `
          <strong>${item.title}</strong><br/>
          ${item.size ? `Size: ${item.size}<br/>` : ""}
          ${item.palette ? `Palette: ${item.palette}<br/>` : ""}
          Quantity: ${item.quantity || 1}<br/>
          Price: ₹${item.price}${item.quantity > 1 ? " each" : ""}
        `;
        cartList.appendChild(li);
      });
      const totalAmount = cartItems.reduce(
        (t, i) => t + (i.price * (i.quantity || 1)), 0
      );
      cartTotal.textContent = `Total: ₹${totalAmount}`;
      if (shouldShowPhotoUpload(cartItems)) {
        photoUploadContainer.style.display = "block";
        photoUploadInput.required = true;
      } else {
        photoUploadContainer.style.display = "none";
        photoUploadInput.required = false;
        photoUploadInput.value = "";
      }
    }

    // Convert file to Base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    // Save order to Supabase with Base64 photo
    async function saveOrderToSupabase(orderData) {
      try {
        console.log('Saving order to Supabase...');

        // Convert photo to Base64 if provided
        let photoBase64 = null;
        if (orderData.photoFile) {
          console.log('Converting photo to Base64...');
          photoBase64 = await fileToBase64(orderData.photoFile);
          console.log('Photo converted to Base64, length:', photoBase64.length);
        }

        const { data: order, error: orderError } = await supabase
          .from('orders')
          .insert([
            {
              customer_name: orderData.customerName,
              last_name: orderData.lastName,
              email: orderData.email,
              address: orderData.address,
              apartment: orderData.apartment,
              city: orderData.city,
              state: orderData.state,
              phone: orderData.phone,
              pincode: orderData.pincode,
              total_amount: orderData.totalAmount,
              product_list: JSON.stringify(orderData.productList),
              comments: orderData.comments,
              photo_url: photoBase64, // Store Base64 string directly in photo_url
              status: 'pending',
            }
          ])
          .select();
        if (orderError) {
          console.error('Order insert error:', orderError);
          throw orderError;
        }
        console.log('Order saved successfully:', order[0].id);
        return order[0].id;
      } catch (error) {
        console.error('Error saving order:', error);
        throw error;
      }
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      setTimeout(() => { successDiv.style.display = 'none'; }, 3000);
    }

    // Form submission handler
    document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      console.log('Form submitted');
      // Hide previous messages
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
      const requiredFields = [
        "email", "firstName", "lastName", "address",
        "city", "state", "phone", "pincode"
      ];
      if (photoUploadContainer.style.display === "block") {
        requiredFields.push("photoUpload");
      }
      let valid = true;
      for (const id of requiredFields) {
        const el = document.getElementById(id);
        if (!el) continue;
        if (el.type === "file" && el.files.length === 0) {
          el.style.borderColor = "red"; 
          valid = false;
        } else if (el.type !== "file" && !el.value.trim()) {
          el.style.borderColor = "red"; 
          valid = false;
        } else {
          el.style.borderColor = "";
        }
      }
      if (!valid) {
        showError("Please fill all required fields" +
          (photoUploadContainer.style.display === "block" ? " and upload your photo." : "."));
        return;
      }
      const totalAmount = cartItems.reduce((total, item) => total + (item.price * (item.quantity || 1)), 0);
      const orderData = {
        customerName: document.getElementById("firstName").value.trim(),
        lastName: document.getElementById("lastName").value.trim(),
        email: document.getElementById("email").value.trim(),
        address: document.getElementById("address").value.trim(),
        apartment: document.getElementById("apartment").value.trim(),
        city: document.getElementById("city").value.trim(),
        state: document.getElementById("state").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        pincode: document.getElementById("pincode").value.trim(),
        comments: document.getElementById("comments").value.trim(),
        totalAmount: totalAmount,
        productList: cartItems,
        photoFile: photoUploadContainer.style.display === "block" ? photoUploadInput.files[0] : null
      };
      const submitButton = document.getElementById("submitButton");
      const originalText = submitButton.textContent;
      submitButton.textContent = "Processing...";
      submitButton.disabled = true;
      try {
        const orderId = await saveOrderToSupabase(orderData);
        localStorage.removeItem("magpieCart");
        // Save payment data in sessionStorage
        sessionStorage.setItem('paymentOrderId', orderId);
        sessionStorage.setItem('paymentAmount', totalAmount.toFixed(2));
        // Redirect to payment page
        window.location.href = 'payment.html';
      } catch (error) {
        console.error('Form submission error:', error);
        showError("There was an error processing your order: " + error.message);
      } finally {
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      }
    });

    renderCart();
  </script>
</body>
</html>
